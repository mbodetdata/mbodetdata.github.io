<section id="blog" class="section" aria-labelledby="blog-title">
  <h2 id="blog-title">Articles récents</h2>

  {% assign posts_visible = site.posts | where_exp: "post", "post.active != false" %}
  {% assign posts_sorted = posts_visible | sort: 'date' | reverse %}

  {% if posts_sorted == empty %}
    <p class="muted">Aucun article publié pour le moment.</p>
  {% else %}
    <div class="carousel" data-carousel="blog" data-carousel-label="l’article" aria-roledescription="carousel">
      <button class="carousel__btn prev" type="button" aria-label="Défiler vers la gauche" disabled>&lt;</button>

      <ul class="carousel__track" role="listbox" aria-label="Derniers articles">
        {% for post in posts_sorted limit:3 %}
          {% assign idx = forloop.index0 %}

          {%- comment -%} Temps de lecture {%- endcomment -%}
          {% assign words = post.content | strip_html | strip_newlines | replace: '  ', ' ' | split: ' ' | size %}
          {% assign minutes = words | divided_by: 220 | plus: 1 %}

          {%- comment -%} Base de l’extrait (excerpt si dispo, sinon contenu) {%- endcomment -%}
          {% assign excerpt_src = post.excerpt | default: post.content %}


          {% assign after_script = excerpt_src | split: '</script>' | last %}
          {% if after_script != excerpt_src %}
            {% assign excerpt_base = after_script %}
          {% else %}
            {% assign excerpt_base = excerpt_src %}
          {% endif %}

          {%- comment -%} Extrait final propre {%- endcomment -%}
          {% assign excerpt = excerpt_base
            | strip_html
            | strip_newlines
            | replace: '  ', ' '
            | truncate: 160
          %}

          <li class="carousel__slide" role="option" aria-describedby="post-desc-{{ idx }}">
            <article class="card blog-card">
              <h3 class="card-title"><a href="{{ post.url | relative_url }}">{{ post.title }}</a></h3>
              <p class="lead" id="post-desc-{{ idx }}">{{ excerpt }}</p>

              <div class="card-meta muted">
                <time datetime="{{ post.date | date_to_xmlschema }}">{{ post.date | date: "%d %b %Y" }}</time>
                <span aria-hidden="true">&middot;</span>
                <span>~{{ minutes }} min</span>
              </div>

              <div class="card-actions">
                <a class="btn btn--details" href="{{ post.url | relative_url }}" aria-label="Lire l’article {{ post.title }}">
                  Lire l’article
                </a>
              </div>
            </article>
          </li>
        {% endfor %}
      </ul>

      <button class="carousel__btn next" type="button" aria-label="Défiler vers la droite">&gt;</button>
      <div class="carousel__dots" aria-label="Sélecteur d’articles"></div>
    </div>
  {% endif %}
</section>

<section id="blog" class="section recent-posts" aria-labelledby="recent-posts-title">
  <div class="recent-posts__inner">
    <header class="recent-posts__head">
      <p class="recent-posts__eyebrow">Blog</p>
      <h2 id="recent-posts-title" class="recent-posts__title">Articles récents</h2>
      <p class="recent-posts__subtitle">
        Sélection d’articles autour de la data, de l’automatisation et de Power&nbsp;BI.
      </p>
    </header>

    {% assign posts_visible = site.posts | where_exp: "post", "post.active != false" %}
    {% assign posts_sorted = posts_visible | sort: 'date' | reverse %}

    {% if posts_sorted == empty %}
      <p class="muted">Aucun article publié pour le moment.</p>
    {% else %}
    <div class="recent-posts__body">
      <div class="recent-posts__carousel carousel" data-carousel="blog" data-carousel-label="l’article" aria-roledescription="carousel">
        <button class="carousel__btn prev" type="button" aria-label="Défiler vers la gauche">&lsaquo;</button>

        <ul class="carousel__track" role="listbox" aria-label="Liste d’articles">
          {% for post in posts_sorted limit:3 %}
            {% assign idx = forloop.index0 %}

            {%- comment -%} Temps de lecture {%- endcomment -%}
            {% assign words = post.content | strip_html | strip_newlines | replace: '  ', ' ' | split: ' ' | size %}
            {% assign minutes = words | divided_by: 220 | plus: 1 %}

            {%- comment -%} Base de l’extrait (excerpt si dispo, sinon contenu) {%- endcomment -%}
            {% assign excerpt_src = post.excerpt | default: post.content %}
            {% assign after_script = excerpt_src | split: '</script>' | last %}
            {% if after_script != excerpt_src %}
              {% assign excerpt_base = after_script %}
            {% else %}
              {% assign excerpt_base = excerpt_src %}
            {% endif %}

            {% assign excerpt = excerpt_base
              | strip_html
              | strip_newlines
              | replace: '  ', ' '
              | truncate: 160
            %}

            <li class="carousel__slide" role="option" aria-describedby="post-desc-{{ idx }}">
              <article class="recent-post-card">
                {% if post.image %}
                  <div class="recent-post-card__media">
                    <img src="{{ post.image | relative_url }}" alt="" loading="lazy" decoding="async">
                  </div>
                {% endif %}

                <div class="recent-post-card__meta muted">
                  <time datetime="{{ post.date | date_to_xmlschema }}">{{ post.date | date: "%d %b %Y" }}</time>
                  <span aria-hidden="true">&middot;</span>
                  <span>~{{ minutes }} min</span>
                </div>

                <h3 class="recent-post-card__title">
                  <a href="{{ post.url | relative_url }}">{{ post.title }}</a>
                </h3>

                <p class="recent-post-card__excerpt" id="post-desc-{{ idx }}">{{ excerpt }}</p>

                {% if post.tags and post.tags.size > 0 %}
                  <ul class="recent-post-card__tags" aria-label="Tags">
                    {% for tag in post.tags limit:4 %}
                      <li><span class="chip">{{ tag }}</span></li>
                    {% endfor %}
                  </ul>
                {% endif %}

                <div class="recent-post-card__footer">
                  <a class="btn btn--details" href="{{ post.url | relative_url }}" aria-label="Lire l’article {{ post.title }}">
                    Lire l’article
                  </a>
                </div>
              </article>
            </li>
          {% endfor %}
        </ul>

        <button class="carousel__btn next" type="button" aria-label="Défiler vers la droite">&rsaquo;</button>
        <div class="carousel__dots" aria-label="Sélecteur d’articles"></div>
      </div>
    </div>
    {% endif %}
  </div>
</section>
